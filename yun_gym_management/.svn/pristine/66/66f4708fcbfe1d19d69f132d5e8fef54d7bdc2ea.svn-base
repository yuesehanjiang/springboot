<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yun.mapper.UserShowMapper">
	
	<!-- 查询待审核的数据 -->
	<select id="getExamineInfo" resultType="UserShow">
		select 
			id,
			nickname,
			(
				case
					when sex = 1 then '男会员'
					else '女会员'
				end
			) as sex,
			signature,
			image,
			date_format(create_time, '%Y-%m-%d %H:%i:%S') as createTime
		from user_show where examine = 0 and gym_addr = #{gymAddr}
		and concat(nickname,signature) like CONCAT('%',#{keyword},'%') 
		limit ${pageNum}, ${pageSize}
	</select>
	
	<!-- 查询审核的详情 -->
	<select id="getExamineDetailsInfo" resultType="UserShow">
		select 
			id,
			nickname,
			(
				case
					when sex = 1 then '男会员'
					else '女会员'
				end
			) as sex,
			signature,
			image,
			date_format(create_time, '%Y-%m-%d %H:%i:%S') as createTime,
			examine
		from user_show where gym_addr = #{gymAddr}
		and id = #{id}
	</select>
	
	<!-- 查询待审核的数据总数 -->
	<select id="getExamineInfoCount" resultType="int">
		select count(1) from user_show where gym_addr = #{gymAddr} and examine = 0
		and concat(nickname,signature) like CONCAT('%',#{keyword},'%') 
	</select>
	
	<!-- 删除已审核的数据 -->
	<delete id="delExamineAdoptInfo">
		update user_show set examine_del = 0
		where id = #{value}
	</delete>
	
	<!-- 查询已审核的数据 -->
	<select id="getExamineAdoptInfo" resultType="UserShow">
		select 
			id,
			nickname,
			(
				case
					when sex = 1 then '男会员'
					else '女会员'
				end
			) as sex,
			signature,
			image,
			examine,
			date_format(create_time, '%Y-%m-%d %H:%i:%S') as createTime
		from user_show where examine != 0 and gym_addr = #{gymAddr}
		and examine_del = 1
		and concat(nickname,signature) like CONCAT('%',#{keyword},'%') 
		<if test="examine != null and examine != ''">
			and examine = #{examine}
		</if>
		limit ${pageNum}, ${pageSize}
	</select>
	
	<!-- 查询要已审核的数据总数 -->
	<select id="getExamineAdoptInfoCount" resultType="int">
		select count(1) from user_show where examine != 0 
		and gym_addr = #{gymAddr} and examine_del = 1
		<if test="examine != null and examine != ''">
			and examine = #{examine}
		</if>
		and concat(nickname,signature) like CONCAT('%',#{keyword},'%') 
	</select>
	
	<!-- 同意审核 -->
	<update id="examineUserShow">
		update user_show set examine = 1 where id = #{value}
	</update>
	
	<!-- 拒绝审核 -->
	<update id="examineRefuseUserShow">
		update user_show set examine = 2 where id = #{value}
	</update>
	
	<!-- 查询会员秀 -->
	<select id="listUserShowInfo" resultType="UserShow">
		select
			id,
			nickname,
			sex,
			image,
			signature
		from user_show
		where gym_addr = #{gymAddr}
		<if test="keyword != null and keyword != ''">
			and concat(nickname,signature) like CONCAT('%',#{keyword},'%') 
		</if>
		<if test="sex == '2'.toString()">
			and sex = 1
		</if>
		<if test="sex == '3'.toString()">
			and sex = 0
		</if>
		<if test="examine == '1'.toString()">
			and examine = 1
		</if>
		order by create_time desc
		limit ${pageNum}, ${pageSize}
	</select>
	
	<!-- 删除会员秀 -->
	<delete id="delUserShow">
		delete from user_show where id = #{value}
	</delete>
	
	<!-- 查询要修改的会员秀 -->
	<select id="getUserShow" resultType="UserShow">
		SELECT
			id,
			nickname,
			sex,
			image,
			signature,
			gym_addr
		FROM
			user_show
		WHERE id = #{value}
	</select>
	
	<!-- 修改会员秀 -->
	<update id="updateUserShow">
		update user_show
		<set>
			<if test="nickname != null and nickname != ''">
				nickname = #{nickname}, 
			</if>
			<if test="image != null and image != ''">
				image = #{image}, 
			</if>
			<if test="sex != null and sex != ''">
				sex = #{sex}, 
			</if>
			<if test="signature != null and signature != ''">
				signature = #{signature}, 
			</if>
		</set>
		where id = #{id}
		and gym_addr = #{gymAddr}
	</update>
	
	<!-- 查询会员秀总数 -->
	<select id="getUserShowCount" resultType="int">
		select count(1) from user_show where gym_addr = #{gymAddr}
		<if test="keyword != null and keyword != ''">
			and concat(nickname,signature) like CONCAT('%',#{keyword},'%') 
		</if>
		<if test="sex == '2'.toString()">
			and sex = 1
		</if>
		<if test="sex == '3'.toString()">
			and sex = 0
		</if>
		<if test="examine == '1'.toString()">
			and examine = 1
		</if>
	</select>
	
	<!-- 会员保持在100 -->
	<select id="getUserShowCountByGymAddr" resultType="int">
		select count(1) from user_show where gym_addr = #{gymAddr}
	</select>
	
	<!-- 查询最小的时间 -->
	<select id="getMinCreateTime" resultType="string">
		select min(create_time) from user_show where gym_addr = #{value}
	</select>
	
	<!-- 删除最前面新增的图片 -->
	<delete id="deleteUserShowByCreate">
		delete from user_show where gym_addr = #{gymAddr} and create_time = #{createTime}
	</delete>
	
	<!-- 新增会员秀 -->
	<insert id="saveUserShow">
		insert into user_show (
			nickname,
			sex,
			image,
			type,
			signature,
			create_time,
			gym_addr
		) values (
			#{nickname},
			#{sex},
			#{image},
			<choose>
				<when test="type == '1'.toString()">1,</when>
				<otherwise>0,</otherwise>
			</choose>
			#{signature},
			now(),
			#{gymAddr}
		)
	</insert>

</mapper>