<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.alibaba.dao.EntranceReportStoreMapper">
  	
  	<!-- 门店信息 -->
	<resultMap id="base_resultMap" type="com.alibaba.pojo.Role">
		<id column="stores_id" property="stores_id" />
		<result column="stores_name" property="stores_name" />
		<!-- 权限信息 -->
		<collection property="relations" ofType="com.alibaba.pojo.Relation">
			<id column="relid" property="relid" />
			<result column="relationName" property="relationName" />
		</collection>
	</resultMap>
	
  	<!-- 查询入场报告门店列表信息 -->
	<select id="getUserRoleRelationInfo" resultMap="base_resultMap" parameterType="com.alibaba.util.ParamInfo">
		SELECT
			r.stores_id,
			r.stores_name,
			rel.relid,
			rel.relation_name AS relationName
		FROM
			(SELECT * FROM stores) r
		LEFT JOIN user_role_relation urr ON urr.stores_id = r.stores_id
		LEFT JOIN relation rel ON rel.relid = urr.relation_id
		LEFT JOIN `user` u ON u.id = urr.user_id
		WHERE
			u.id = #{user_id}
		and urr.relation_id = 4
	</select>
  	
 	<!-- 查询入场报告-会员 -->
  	<select id="getEntranceReportInfo" resultType="com.alibaba.util.ParamInfo" parameterType="com.alibaba.util.ParamInfo">
  		select 
  			id,
			user_name,
			stores_id,
			stores_name,
			userId,
			user_card,
			user_pic,
			count(userId) as frequency,
			user_type,
			user_in_time
  		from 
  		(
  			SELECT
				a.id as id,
				m.user_name as user_name,
				GROUP_CONCAT(distinct a.stores_id) as stores_id,
				GROUP_CONCAT(distinct s.stores_name) as stores_name,
				a.user_id as userId,
				a.user_card as user_card,
				m.user_pic as user_pic,
			  	count(a.user_id) as frequency,
				mp.user_type as user_type,
				a.user_in_time as user_in_time
			FROM
				admission a
			LEFT JOIN membership m ON m.user_id = a.user_id
			LEFT JOIN management_pic mp ON mp.user_id = a.user_id
			LEFT JOIN stores s ON s.stores_id = a.stores_id
			group by a.user_id,a.id <if test="(datetime != null and datetime != '') or ( ( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' ) ) ">,a.user_in_time</if>
			<if test="stores_id != null and stores_id != ''">,a.stores_id</if>
			having 1=1
			and stores_id in ( ${content} )
			and mp.user_type = #{user_type}
			<if test="keyword != null and keyword != ''">
				and concat(m.user_name, a.user_id, a.user_card) like '%${keyword}%'
			</if>
			<if test="stores_id != null and stores_id != ''">
				and a.stores_id = #{stores_id}
			</if>
			<if test="datetime != null and datetime != ''">
		 		and date(a.user_in_time) = #{datetime}
		 	</if>
		 	<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(a.user_in_time) between #{startTime} and #{endTime}
			</if>
  		) as count group by userId
  		<if test="positive != null and positive != ''">
			order by frequency desc
		</if>
		<if test="reverse != null and reverse != ''">
			order by frequency asc
		</if>
		<if test="(pageNum != null and pageNum != '') and ( pageSize != null and pageSize != '' ) ">
			limit ${pageNum}, ${pageSize}
		</if>
  	</select>
  	
  	<!-- 筛选非会员数据 -->
  	<select id="getEntranceReportNonMemberInfo" resultType="com.alibaba.util.ParamInfo" parameterType="com.alibaba.util.ParamInfo">
  		select 
			non.stores_id,
			non.user_name,
			( case  when 1 = 1 then '-/-' end ) as user_id,
			( case  when 1 = 1 then '-/-' end ) as user_card,
			( case  when 1 = 1 then '-/-' end ) as user_pic,
			( case  when 1 = 1 then '1' end ) as frequency,
			non.id,
			s.stores_name
		 from non_member non
		 LEFT JOIN stores s ON s.stores_id = non.stores_id
		<where>
			 and non.stores_id in ( ${content} )
		 	<if test="stores_id != null and stores_id != ''">
		 		and non.stores_id = #{stores_id}
		 	</if>
		 	<if test="keyword != null and keyword != ''">
				and non.user_name like '%${keyword}%'
			</if>
		 	<if test="datetime != null and datetime != ''">
		 		and date(non.user_in_time) = #{datetime}
		 	</if>
		 	<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(non.user_in_time) between #{startTime} and #{endTime}
			</if>
		 </where>
		<if test="(pageNum != null and pageNum != '') and ( pageSize != null and pageSize != '' ) ">
			limit ${pageNum}, ${pageSize}
		</if>
  	</select>
  	
  	<!-- 查询总数 -->
  	<select id="getCount3" parameterType="com.alibaba.util.ParamInfo" resultType="int">
  		select count(1) from (
  			select 
				stores_id,
				user_name,
				( case  when 1 = 1 then '-/-' end ) as user_id,
				( case  when 1 = 1 then '-/-' end ) as user_card,
				( case  when 1 = 1 then '-/-' end ) as user_pic,
				( case  when 1 = 1 then '1' end ) as frequency,
				id
			 from non_member
			<where>
				and stores_id in ( ${content} )
			 	<if test="stores_id != null and stores_id != ''">
			 		and stores_id = #{stores_id}
			 	</if>
			 	<if test="keyword != null and keyword != ''">
					and user_name like '%${keyword}%'
				</if>
			 	<if test="datetime != null and datetime != ''">
			 		and date(user_in_time) = #{datetime}
			 	</if>
			 	<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
					and date(user_in_time) between #{startTime} and #{endTime}
				</if>
			 </where>
		) as count
  	</select>
  	
  	<!-- 筛选非会员详情数据 -->
  	<select id="getEntranceReportNonMemberDetails" resultType="com.alibaba.util.ParamInfo" parameterType="com.alibaba.util.ParamInfo">
  		select 
			s.stores_name,
			non.stores_id,
			non.user_name,
			( case  when 1 = 1 then '-/-' end ) as user_id,
			( case  when 1 = 1 then '-/-' end ) as user_card,
			non.user_in_time,
			( case  when 1 = 1 then '-/-' end ) as user_pic,
			non.id
		 from non_member non
		 LEFT JOIN stores s ON s.stores_id = non.stores_id
		 where non.id = #{u_id}
  	</select>
  	
  	<!-- 查询总数 -->
  	<select id="getCount" resultType="int" parameterType="com.alibaba.util.ParamInfo">
  		select count(1) from ( 
	  		SELECT
				a.id,
				m.user_name,
				GROUP_CONCAT(distinct a.stores_id) as stores_id,
				GROUP_CONCAT(distinct s.stores_name) as stores_name,
				a.user_id,
				a.user_card,
				m.user_pic,
			  	count(a.user_id) as frequency,
				mp.user_type,
				a.user_in_time
			FROM
				admission a
			LEFT JOIN membership m ON m.user_id = a.user_id
			LEFT JOIN management_pic mp ON mp.user_id = a.user_id
			LEFT JOIN stores s ON s.stores_id = a.stores_id
			group by a.user_id <if test="(datetime != null and datetime != '') or ( ( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' ) ) ">,a.user_in_time</if>
			<if test="stores_id != null and stores_id != ''">,a.stores_id</if>
			having 1=1
			and stores_id in ( ${content} )
			and mp.user_type = #{user_type}
			<if test="keyword != null and keyword != ''">
				and concat(m.user_name, a.user_id, a.user_card) like '%${keyword}%'
			</if>
			<if test="stores_id != null and stores_id != ''">
				and a.stores_id = #{stores_id}
			</if>
			<if test="datetime != null and datetime != ''">
		 		and date(a.user_in_time) = #{datetime}
		 	</if>
		 	<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(a.user_in_time) between #{startTime} and #{endTime}
			</if>
  		 ) as count
  	</select>
  	
  	<!-- 查询总数 -->
  	<select id="getCount2" resultType="int" parameterType="com.alibaba.util.ParamInfo">
  		select count(1) from (
  			SELECT
				a.id,
				m.user_name,
				a.stores_id,
				a.user_id,
				a.user_card,
				mp.pic_path,
				a.user_in_time
			FROM
				admission a
			LEFT JOIN membership m ON m.user_id = a.user_id
			LEFT JOIN management_pic mp ON mp.user_id = a.user_id
			where a.stores_id in ( ${content} )
			and a.user_id = #{u_id}
			<if test="stores_id != null and stores_id != ''">
				and a.stores_id = #{stores_id}
			</if>
			<if test="datetime != null and datetime != ''">
				and date(a.user_in_time) = #{datetime}
			</if>
			<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(a.user_in_time) between #{startTime} and #{endTime}
			</if>
			group by a.id
		) as count
  	</select>

	<!-- 查询入场次数详情-会员 -->
	<select id="getgetEntranceReportDetails" resultType="com.alibaba.util.ParamInfo" parameterType="com.alibaba.util.ParamInfo">
		SELECT
			a.id,
			m.user_name,
			a.stores_id,
			a.user_id,
			a.user_card,
			(
				case 
					when mp.pic_path is null then '-/-'
					else mp.pic_path
				end
			) as user_pic,
			a.user_in_time,
			s.stores_name
		FROM
			admission a
		LEFT JOIN membership m ON m.user_id = a.user_id
		LEFT JOIN management_pic mp ON mp.user_id = a.user_id and a.uuid = mp.uuid
		LEFT JOIN stores s ON s.stores_id = a.stores_id
		where a.stores_id in ( ${content} )
		and a.user_id = #{u_id}
		<if test="stores_id != null and stores_id != ''">
			and a.stores_id = #{stores_id}
		</if>
		<if test="datetime != null and datetime != ''">
			and date(a.user_in_time) = #{datetime}
		</if>
		<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
			and date(a.user_in_time) between #{startTime} and #{endTime}
		</if>
		GROUP BY a.id
		<if test="(pageNum != null and pageNum != '') and ( pageSize != null and pageSize != '' ) ">
			limit ${pageNum}, ${pageSize}
		</if>
	</select>
	
</mapper>