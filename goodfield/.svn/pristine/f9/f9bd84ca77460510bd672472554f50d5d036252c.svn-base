<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.alibaba.dao.JiGuangMapper">
	<resultMap id="base_resultMap" type="com.alibaba.pojo.Folder">
		<id column="id" property="id" />
		<result column="folderName" property="folderName" />
		<result column="stores_name" property="stores_name" />
		<result column="stores_id" property="stores_id" />
		<result column="startTime" property="startTime" />
		<result column="endTime" property="endTime" />
		<result column="screen_type" property="screenType" />
		<result column="content_type" property="content_type" />
		<result column="unlimited_time" property="unlimited_time" />
		<result column="live_status" property="live_status" />
		<result column="rePlayDate" property="rePlayDate" />
		<!-- pushstatus 表 -->
		<association property="pushStatus" javaType="com.alibaba.pojo.PushStatus1">

			<result column="machine_is_delete" property="machine_is_delete" />
			<result column="is_ting" property="is_ting" />
		</association>
		<!-- 文件信息 -->
		<collection property="files" ofType="com.alibaba.pojo.File">
			<id column="fid" property="fid" />
			<result column="fileName" property="fileName" />
			<result column="filePath" property="filePath" />
			<result column="file_size" property="file_size" />
		</collection>

	</resultMap>



	<resultMap id="folderMap" type="com.alibaba.pojo.Folder">
		<id column="id" property="id" />
		<result column="folder_name" property="folderName" />
		<result column="gym_addr" property="gymAddr" />
		<result column="start_time" property="startTime" />
		<result column="end_time" property="endTime" />
		<result column="screen_type" property="screenType" />
		<result column="content_type" property="contentType" />
		<result column="unlimited_time" property="unlimitedTime" />

		<result column="rePlayDate" property="rePlayDate" />
		<result column="rePlayTime" property="rePlayTime" />

		<result column="push_is" property="pushIsAll" />

		<result column="machine_ids" property="machineIds" />

		<result column="status" property="status" />

	</resultMap>




	<resultMap id="folderFileMap" type="com.alibaba.pojo.Folder">
		<id column="id" property="id" />
		<result column="folder_name" property="folderName" />
		<result column="gym_addr" property="gymAddr" />
		<result column="start_time" property="startTime" />
		<result column="end_time" property="endTime" />
		<result column="screen_type" property="screenType" />
		<result column="content_type" property="contentType" />
		<result column="unlimited_time" property="unlimitedTime" />
    
       <result column="clubName" property="clubName" />
		<result column="rePlayDate" property="rePlayDate" />
		<result column="rePlayTime" property="rePlayTime" />

		<result column="push_is" property="pushIsAll" />

		<result column="machine_ids" property="machineIds" />

		<result column="status" property="status" />

		<!-- 文件信息 -->
		<collection property="files" ofType="com.alibaba.pojo.File">
			<id column="fid" property="fid" />
			<result column="file_name" property="fileName" />
			<result column="file_path" property="filePath" />
			<result column="file_size" property="fileSize" />
		</collection>

	</resultMap>


	<!-- //删除文件时候的推送查找推送的文件 停泊 Folder selectFileByFloderidtoDel(@Param("floderid")String 
		floderid, @Param("machineId")Object object); -->

	<select id="selectFileByFloderidtoDel" resultMap="base_resultMap">
		SELECT
		f.id,

		p.`machine_is_delete`, p.is_ting,
		f.folder_name AS
		folderName,
		IFNULL(f.start_time, "") AS
		startTime,
		IFNULL(f.end_time, "")
		AS endTime,
		f.screen_type,
		f.content_type,
		f.rePlayDate ,

		(
		case
		when ISNULL(fid)
		then '0'
		else f.live_status
		end
		) as live_status,
		(
		case
		when
		unlimited_time=2 then 1
		else unlimited_time
		end
		) as unlimited_time,


		fi.fid,
		fi.file_name AS fileName,
		fi.file_path AS
		filePath,
		ROUND(fi.file_size /1024/ 1024.0,2) AS
		file_size,
		f.update_time
		FROM
		folder f
		LEFT JOIN `file` fi ON fi.folder_id
		= f.id
		LEFT JOIN
		`push_status` p ON p.folder_id=f.id


		<where>
			f.end_time >NOW()
			<if test="floderid !=null and floderid != ''">
				AND
				f.id =
				#{floderid}
			</if>

			<if test="machineId !=null and machineId !='' ">
				AND p.device_id =#{machineId}
			</if>
		</where>
		-- HAVING SUBSTR(NOW(),1,10)=SUBSTR(startTime,1,10)

	</select>




	<!-- //找找 floder 表中的数据+ Folder selectFolder(@Param("folder_id")String id); -->
	<select id="selectFolder" resultType="com.alibaba.pojo.Folder">
		SELECT
		 *
		FROM
		`folder`
		where id
		=#{folder_id}

		<if test="status != null and status !=''">

			and status=#{status}
		</if>

		<if test="liveStaus !=null and liveStaus !=''">
			and live_status=#{liveStaus}
		</if>

	</select>



	<!-- List<Map> selectFileByFloderid(String floderid); //根据文件夹id 查找可以推送的 
		s文件 s machineId -->
	<select id="selectFileByFloderid" resultMap="base_resultMap">
		SELECT
		f.id,

		p.`machine_is_delete`, p.is_ting,
		f.folder_name AS
		folderName,
		IFNULL(f.start_time, "") AS
		startTime,
		IFNULL(f.end_time, "")
		AS endTime,
		f.screen_type as type,
		f.content_type,
		(
		case unlimited_time
		when 2 then 1
		else 0
		end
		) as unlimited_time,
		f.live_status,
		fi.fid,
		fi.file_name AS
		fileName,
		fi.file_path AS
		filePath,
		ROUND(fi.file_size
		/1024/ 1024.0,2) AS
		file_size,
		f.update_time ,f.rePlayDate
		FROM
		folder f
		LEFT JOIN `file` fi
		ON fi.folder_id
		= f.id
		LEFT JOIN
		`push_status` p ON p.folder_id=f.id
		where 1=1
		-- DATE_ADD(now() ,
		-- INTERVAL 4
		-- HOUR) &lt;= f.start_time
		-- AND f.end_time >NOW()
		-- AND

		-- DATE_ADD(f.start_time ,
		-- INTERVAL 2
		-- HOUR) &lt;=
		-- f.end_time
		<if test="floderid !=null and floderid != ''">
			AND
			f.id =
			#{floderid}
		</if>

		<if test="machineId !=null and machineId !='' ">
			AND p.device_id =#{machineId}
		</if>

		HAVING SUBSTR(NOW(),1,10)=SUBSTR(startTime,1,10)

	</select>



	<!--List<Map> selectmahineByFloderId(@Param("floderid") String floderid); 
		//查到所有可以推送的 终端机 -->


	<select id="selectmahineByFloderId" resultType="java.lang.String">
		SELECT
		machine_code
		FROM
		`machine`
		WHERE gym_addr IN
		(SELECT DISTINCT
		gym_addr
		FROM
		`folder`
		WHERE id = #{floderid})
	</select>


	<!-- void updatePushStatusByFolerid (@Param("folerid")String folerid); //修改pushStaus 
		表的数据 -->
	<update id="updatePushStatusByFolerid">
		UPDATE
		`push_status`
		SET

		`status` = 0,is_delete
		=0
		WHERE
		`folder_id` = #{folerid}

	</update>




	<!-- //根据flowid 和machine——id 来pushStatus 的状态 Map<String, Object> updatePushStatus(@Param("machine_id")String 
		machine_id, @Param("folder_id")String folder_id); -->

	<update id="updatePushStatus">
		UPDATE
		`push_status`
		SET
		status = 1
		WHERE
		`folder_id` =
		#{folder_id}
		and `device_id`=#{machine_id}
	</update>


	<!--//看是不是被删除了 Integer selectStatustoPushStatus(@Param("machine_id")String 
		machine_id, @Param("folder_id")String folder_id); -->

	<select id="selectStatustoPushStatus" resultType="java.lang.Integer">
		SELECT

		DISTINCT
		`is_delete`
		FROM
		`push_status`
		where folder_id =#{folder_id} and
		device_id=#{machine_id}

	</select>


	<!-- //看有没有推送成功 Integer selectStatustoPushStatus1(@Param("machine_id")String 
		machine_id, @Param("folder_id")String folder_id); -->

	<select id="selectStatustoPushStatus1" resultType="java.lang.Integer">
		SELECT

		DISTINCT `status`
		FROM
		`push_status`
		where folder_id
		=#{folder_id} and
		device_id=#{machine_id}

	</select>


	<!-- //改为1 void updatePushStatusto1(@Param("machine_id")String machine_id, 
		@Param("folder_id")String folder_id); -->

	<update id="updatePushStatusto1">
		UPDATE
		`push_status`
		SET
		status = 1
		WHERE
		`folder_id` =
		#{folder_id}
		and
		`device_id`=#{machine_id}

	</update>



	<!-- //根据终端机的id 查找所有的 数据 List<Map> selectAll(@Param("machine_id")String 
		machine_id); -->
	<select id="selectAll" resultType="java.util.Map">
		SELECT
		`id`,
		`folder_id`,
		`device_id`,
		`status`,
		`is_delete`
		FROM
		`push_status` where
		device_id=#{machine_id}
	</select>

	<!-- //插入数据 void insertFolidemachineid(@Param("folder_id")String floderid, 
		@Param("machine_id")String machine_id); -->

	<insert id="insertFolidemachineid">
		INSERT INTO `push_status` (
		`folder_id`,
		`device_id`

		)
		VALUES
		(
		#{folder_id},
		#{machine_id}

		)


	</insert>


	<!-- //找门店字符串 String slectMachine(@Param("folderId")String folderId); -->

	<select id="slectMachine" resultType="java.lang.String">
		SELECT
		`machine_ids`
		FROM
		`folder`
		WHERE id = #{folderId}
	</select>


	<!-- //改改文件夹的状态ss void updateFloerId(@Param("id")String id); -->

	<update id="updateFloerId">
		UPDATE folder SET live_status=0 where id =#{id}
	</update>



	<!-- //删除pushasta 中数据 根据问价夹id 和机器id void deleteByfoleridmachineid(@Param("folderId")String 
		folderId,@Param("machieid") String machieid); -->

	<delete id="deleteByfoleridmachineid">
		DELETE
		FROM
		`push_status`
		WHERE
		folder_id=#{folderId} and
		device_id =#{machieid}
	</delete>




	<!-- //查找问价夹中文件的数量 Integer selectCountfile(@Param("folderId")String folderId); 
		s -->
	<select id="selectCountfile" resultType="java.lang.Integer">
		SELECT
		IFNULL(COUNT(*),0) FROM `file`
		WHERE folder_id =#{folderId}
	</select>


	<!-- List<PushStatus> selectPushStatusByfloderId (@Param("folder_id")String 
		floerid); -->
	<select id="selectPushStatusByfloderId" resultType="com.alibaba.pojo.PushStatus">
		SELECT
		`id`,
		`folder_id`,
		`device_id`,
		`status`,
		`is_delete`,
		`machine_is_delete`
		FROM
		`push_status`

		<where>
			<if test="folder_id !=null and folder_id !=''">
				folder_id =#{folder_id}
			</if>
		</where>
	</select>


	<!-- //给表示 表已经删除 void updatePushstatus_machine_is_delete(@Param("machieId")String 
		machieId, @Param("floderid")String floderid); -->

	<update id="updatePushstatus_machine_is_delete">
		UPDATE
		`push_status`
		SET

		`machine_is_delete` =
		0,
		status=0
		WHERE `folder_id`=#{floderid} AND `device_id`=#{machieId}

	</update>


	<!-- //根据文件夹的id 查找所有pushstaus 数据 List<Map> selectAllbyFlodrid(@Param("floderid")String 
		floderida); -->
	<select id="selectAllbyFlodrid" resultType="java.util.Map">
		select * from
		`push_status` where `folder_id`=#{floderid}

	</select>



	<!-- //终端机删除文件时候的推送 Folder selectFolderByTypeAndFolder(UserFolder userFolder); -->
	<select id="selectFolderByTypeAndFolder" parameterType="com.alibaba.pojo.UserFolder"
		resultMap="base_resultMap">
		SELECT
		f.id,

		p.`machine_is_delete`, p.is_ting,
		f.folder_name AS
		folderName,
		IFNULL(f.start_time, "") AS
		startTime,
		IFNULL(f.end_time, "")
		AS endTime,
		f.type,
		f.content_type,f.rePlayDate ,

		(
		case
		when ISNULL(fid)
		then '0'
		else
		f.live_status
		end
		) as live_status,
		(
		case unlimited_time
		when
		2 then 1
		else 0
		end
		) as unlimited_time,

		fi.fid,
		fi.file_name AS fileName,
		fi.file_path AS
		filePath,
		ROUND(fi.file_size
		/1024/ 1024.0,2) AS
		file_size,
		f.update_time
		FROM
		folder f
		LEFT JOIN `file`
		fi ON fi.folder_id
		= f.id
		LEFT JOIN
		`push_status` p ON p.folder_id=f.id


		<where>
			p.status =0
			<if test="folder_id !=null and folder_id != ''">
				AND
				f.id =
				#{folder_id}
			</if>

			<if test="machineId !=null and machineId !='' ">
				AND p.device_id =#{machineId}
			</if>
			<if test="type !=null and type !='' ">
				AND f.type =#{type}
			</if>
		</where>


	</select>


	<!-- //查找文件 List<Folder> selectFolderbyFolder(ParamInfo pInfo); -->

	<select id="selectFolderbyFolder" resultMap="folderMap">
		select
		`id`,
		`folder_name`,
		`gym_addr`,
		`start_time`,
		`end_time`,
		`screen_type`,
		`status`,
		`content_type`,
		`machine_ids`,
		`unlimited_time`,
		`update_time`,
		`live_status`,
		`user_id`,
		`push_is`,
		`rePlayDate`,
		`rePlayTime` ,
		(select group_concat(machine_code) from `machine` where
		gym_addr=#{gymAddr} )
		as machine_ids,
		(SELECT  DISTINCT `club_name` FROM `club`  WHERE `gym_addr`=#{gymAddr}) as clubName,
		(select  group_concat(DISTINCT(machine_name)) 
		from `machine` where `gym_addr` =#{gymAddr}) as machineName
		from
		`gym`.`folder`
		<where>
			live_status =1
			<if test="gymAddr !=null and gymAddr !=''"> and gym_addr=#{gymAddr} </if>
			<if test="contentType !=null and contentType !=''"> and content_type=#{contentType}</if>
			<if test="screenType !=null and screenType !=''"> and screen_type=#{screenType}</if>

		</where>
		
			limit ${pageNum},${pageSize}
	</select>



	<!-- //查文件夹的详情 List<Folder> selectFolderbyFolderforFile(ParamInfo pInfo); -->

	<select id="selectFolderbyFolderforFile" resultMap="folderFileMap">

		select
		`id`,
		`folder_name`,
		`gym_addr`,
		`start_time`,
		`end_time`,
		`screen_type`,
		`status`,
		`content_type`,
		`machine_ids`,
		`unlimited_time`,
		`update_time`,
		`live_status`,
		`user_id`,
		f.`push_is`,
		`rePlayDate`,
		`rePlayTime` ,
		`fid`,
		`file_name`,
		`file_path`,
		`file_size`,
		(select group_concat(machine_code) from `machine` where gym_addr=#{gymAddr} )
		as machineIds, -- 终端机的ids
		(SELECT  DISTINCT `club_name` FROM `club`  WHERE `gym_addr`=#{gymAddr}) AS clubName,
		(SELECT  GROUP_CONCAT(DISTINCT(machine_name)) FROM `machine` WHERE `gym_addr` =#{gymAddr}) AS machineName
		from
		`gym`.`folder` f
		left join `file` fi on f.`id`=fi.`folder_id`
		<where>
			live_status =1
			<if test="gymAddr !=null and gymAddr !=''"> and gym_addr=#{gymAddr} </if>
			<if test="contentType !=null and contentType !=''"> and content_type=#{contentType}</if>
			<if test="screenType !=null and screenType !=''"> and screen_type=#{screenType}</if>
            <if test="id !=null and id !=''"> and id=#{id}</if>
		</where>
	


	</select>
</mapper>