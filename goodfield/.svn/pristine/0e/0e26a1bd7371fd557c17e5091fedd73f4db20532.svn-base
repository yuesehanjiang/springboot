<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.alibaba.dao.AdmissionMapper">
  	
	<!-- 门店信息 -->
	<resultMap id="base_resultMap" type="com.alibaba.pojo.Role">
		<id column="stores_id" property="stores_id" />
		<result column="stores_name" property="stores_name" />
		<!-- 权限信息 -->
		<collection property="relations" ofType="com.alibaba.pojo.Relation">
			<id column="relid" property="relid" />
			<result column="relationName" property="relationName" />
		</collection>
	</resultMap>
	
	<!-- 查询入场人数统计门店列表信息 -->
	<select id="getUserRoleRelationInfo" resultMap="base_resultMap" parameterType="com.alibaba.util.ParamInfo">
		SELECT
			r.stores_id,
			r.stores_name,
			rel.relid,
			rel.relation_name AS relationName
		FROM
			(SELECT * FROM stores) r
		LEFT JOIN user_role_relation urr ON urr.stores_id = r.stores_id
		LEFT JOIN relation rel ON rel.relid = urr.relation_id
		LEFT JOIN `user` u ON u.id = urr.user_id
		WHERE
			u.id = #{user_id}
		and urr.relation_id = 1
	</select>
	
  	<!-- 查询入场人数统计 -->
	<select id="getIdentityInfo" resultType="com.alibaba.util.ParamInfo" parameterType="com.alibaba.util.ParamInfo">
		SELECT
			count(case when mp.user_type = '0' then '' end ) as memberformer,
			count(case when mp.user_type = '1' then '' end ) as member,
			( 
				select count(1) from non_member nm
				<where>
					and nm.stores_id in ( ${content} )
					<if test="stores_id != null and stores_id != ''">
						and nm.stores_id = #{stores_id} 
					</if>
					<if test="datetime != null and datetime != ''">
						and date(nm.user_in_time) = #{datetime} 
					</if>
					<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
						and date(nm.user_in_time) between #{startTime} and #{endTime}
					</if>
				</where>
			) as nonmember
		FROM
			( select * from admission aa 
				<where>
					<if test="datetime != null and datetime != ''">
						and date( aa.user_in_time ) = #{datetime}
					</if>
					<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
						and date(aa.user_in_time) between #{startTime} and #{endTime}
					</if>
				</where>
			 GROUP BY aa.user_id ) a
		LEFT JOIN ( select * from management_pic mm group by mm.user_id) mp ON mp.user_id = a.user_id
		<where>
			and a.stores_id in ( ${content} )
			<if test="stores_id != null and stores_id != ''">
				and a.stores_id = #{stores_id}
			</if>
		</where>
	</select>
	
	<!-- 查询入场人数统计详情 -->
	<select id="getIdentityInfoDetails" resultType="com.alibaba.util.ParamInfo" parameterType="com.alibaba.util.ParamInfo">
		select 
			a.id,
			a.stores_id,
			s.stores_name,
			a.user_card,
			a.user_in_time,
			mp.user_type,
			m.user_name,
			a.user_id
	    from admission a
		left JOIN membership m ON m.user_id = a.user_id
		left JOIN ( select * from management_pic mm group by mm.user_id) mp ON mp.user_id = a.user_id
		left JOIN stores s ON s.stores_id = a.stores_id
		GROUP BY a.id having 1=1
		and a.stores_id IN ( ${content} )
		and mp.user_type = #{user_type}
		<if test="stores_id != null and stores_id != ''">
			and a.stores_id = #{stores_id}
		</if>
		<if test="keyword != null and keyword != ''">
			and concat(a.user_id, a.user_card, m.user_name) like '%${keyword}%'
		</if>
		<if test="datetime != null and datetime != ''">
			and date(a.user_in_time) = #{datetime}
		</if>
		<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
			and date(a.user_in_time) between #{startTime} and #{endTime}
		</if>
		ORDER BY a.user_in_time desc
		<if test="(pageNum != null and pageNum != '') and (pageSize != null and pageSize != '')">
			limit ${pageNum}, ${pageSize}
		</if>
	</select>
	
	<!-- 查询入场次数 -->
	<select id="getSemberSize" resultType="java.lang.String" parameterType="com.alibaba.util.ParamInfo">
		select count(1) as member from (
			select 
				a.id,
				a.stores_id,
				s.stores_name,
				a.user_card,
				a.user_in_time,
				mp.user_type,
				m.user_name,
				a.user_id
		    from admission a
			left JOIN membership m ON m.user_id = a.user_id
			left JOIN ( select * from management_pic mm group by mm.user_id) mp ON mp.user_id = a.user_id
			left JOIN stores s ON s.stores_id = a.stores_id
			GROUP BY a.id having 1=1
			<if test="datetime != null and datetime != ''">
				and date(a.user_in_time) = #{datetime}
			</if>
			<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(a.user_in_time) between #{startTime} and #{endTime}
			</if>
			and a.stores_id IN ( ${content} )
			and mp.user_type = '1'
		) as count
			union all
		select count(1) from (
			select 
				a.id,
				a.stores_id,
				s.stores_name,
				a.user_card,
				a.user_in_time,
				mp.user_type,
				m.user_name,
				a.user_id
		    from admission a
			left JOIN membership m ON m.user_id = a.user_id
			left JOIN ( select * from management_pic mm group by mm.user_id) mp ON mp.user_id = a.user_id and mp.uuid = a.uuid
			left JOIN stores s ON s.stores_id = a.stores_id
			GROUP BY a.id having 1=1
			<if test="datetime != null and datetime != ''">
				and date(a.user_in_time) = #{datetime}
			</if>
			<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(a.user_in_time) between #{startTime} and #{endTime}
			</if>
			and a.stores_id IN ( ${content} )
			and mp.user_type = '0'
		) as count
			union all
		select count(1) from non_member nm
		where 1=1
		<if test="datetime != null and datetime != ''">
			and date(nm.user_in_time) = #{datetime}
		</if>
		<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
			and date(nm.user_in_time) between #{startTime} and #{endTime}
		</if>
		and nm.stores_id in ( ${content} )
	</select>
	
	<!-- 查询非会员信息 -->
	<select id="getnonMember" resultType="com.alibaba.util.ParamInfo" parameterType="com.alibaba.util.ParamInfo">
		select 
			nm.id,
			nm.stores_id,
			nm.user_name,
			nm.user_in_time,
			s.stores_name,
			( case when 1=1 then '-/-' end ) as user_card,
			( case when 1=1 then '-/-' end ) as user_id
		from non_member nm
		left join stores s ON s.stores_id = nm.stores_id
		<where>
			and nm.stores_id in ( ${content} )
			<if test="stores_id != null and stores_id != ''">
				and nm.stores_id = #{stores_id}
			</if>
			<if test="keyword != null and keyword != ''">
				and concat(nm.user_name) like '%${keyword}%'
			</if>
			<if test="datetime != null and datetime != ''">
				and date(nm.user_in_time) = #{datetime}
			</if>
			<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(nm.user_in_time) between #{startTime} and #{endTime}
			</if>
			ORDER BY nm.user_in_time desc
		</where>
		<if test="( pageNum != null and pageNum != '') and ( pageSize != null and pageSize != '' ) ">
			limit ${pageNum}, ${pageSize}
		</if>
	</select>
	
	<!-- 查询总数 -->
	<select id="getCount" resultType="int" parameterType="com.alibaba.util.ParamInfo">
		select 
			count(1)
	    from admission a
		left JOIN membership m ON m.user_id = a.user_id
		left JOIN ( select * from management_pic mm group by mm.user_id) mp ON mp.user_id = a.user_id
		<where>
			and a.stores_id IN ( ${content} )
			and mp.user_type = #{user_type}
			<if test="stores_id != null and stores_id != ''">
				and a.stores_id = #{stores_id}
			</if>
			<if test="keyword != null and keyword != ''">
				and concat(a.user_id, a.user_card, m.user_name) like '%${keyword}%'
			</if>
			<if test="datetime != null and datetime != ''">
				and date(a.user_in_time) = #{datetime}
			</if>
			<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(a.user_in_time) between #{startTime} and #{endTime}
			</if>
		</where>
	</select>
	
	<select id="getCount2" resultType="int" parameterType="com.alibaba.util.ParamInfo">
		select 
			count(1)
		from non_member nm
		<where>
			and nm.stores_id in ( ${content} )
			<if test="stores_id != null and stores_id != ''">
				and nm.stores_id = #{stores_id}
			</if>
			<if test="keyword != null and keyword != ''">
				and concat(nm.user_name) like '%${keyword}%'
			</if>
			<if test="datetime != null and datetime != ''">
				and date(nm.user_in_time) = #{datetime}
			</if>
			<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(nm.user_in_time) between #{startTime} and #{endTime}
			</if>
		</where>
	</select>
	    
</mapper>