<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.alibaba.dao.UserMapper">
  	
  	<!-- 查询为读状态 -->
  	<select id="getUnread" resultType="java.lang.Integer">
  		select unread from `user` where id = #{id}
  	</select>
  	
  	<!-- 修改为读状态 -->
  	<update id="updateUnread">
  		update user set
  		unread = 1 where id = #{id}
  	</update>
  	
  	<!-- 修改为读状态 -->
  	<update id="updateNotUnread">
  		update user set
  		unread = 0 where id = #{id}
  	</update>
  	
  	<!-- 用户登陆 -->
  	<select id="userLogin" resultType="com.alibaba.pojo.User" parameterType="com.alibaba.pojo.User">
  		SELECT
			u.id,
			u.account,
			u.status,
			u.username,
			u.phone,
			u.pic,
			u.loginStatus
		FROM
			`user` u
		WHERE u.`status` = 1
		AND ( u.account = #{account} or u.phone = #{account} )
		AND u.`password` = #{password}
  	</select>
  	
  	<!-- 查询登录状态 -->
	<select id="getLoginStatus" resultType="java.lang.String" parameterType="com.alibaba.pojo.User">
		select loginStatus from user where id = #{id}
	</select>
	
	<!-- 修改登录状态 -->
	<update id="updateLoginStatus" parameterType="com.alibaba.pojo.User">
		update user set
		loginStatus = #{loginStatus}
		where id = #{id}
	</update>
  	
  	<!-- 查询终端机总数 -->
  	<select id="getMachineCount" resultType="int" parameterType="com.alibaba.util.ParamInfo">
  		select sum(frequency) as sum from (
			SELECT
				u.account,
				s.stores_city as stores_city,
				s.stores_name,
				s.stores_id,
				GROUP_CONCAT( DISTINCT m.machine_name ) as machine_name,
				GROUP_CONCAT( DISTINCT m.machine_id) as machine_id,
				count(DISTINCT machine_id) as frequency,
				( 
					select GROUP_CONCAT(m.`status`) from machine m where m.stores_id = s.stores_id 
					GROUP BY m.stores_id ) as `status`
			FROM
				 ( 
					select * from `user`
				 ) u
			LEFT JOIN user_role_relation urr ON urr.user_id = u.id
			LEFT JOIN stores s ON s.stores_id = urr.stores_id
			LEFT JOIN machine m ON m.stores_id = urr.stores_id
			where u.`status` = 1
			and u.account = #{account}
			and m.stores_id not in ( ${content} )
			GROUP BY u.account, s.stores_name
			having 1=1
			and frequency != '0'
		) as sum
  	</select>
  	
  	<!-- 根据城市查询总数 -->
  	<select id="getStoresCitySum" resultType="java.lang.String" parameterType="com.alibaba.util.ParamInfo">
  		select sum(frequency) from (
  			select SUM(frequency) as frequency from (
				SELECT
					u.phone,
					u.account,
					s.stores_city,
					s.stores_name,
					s.stores_id,
					GROUP_CONCAT( DISTINCT m.machine_name ) as machine_name,
					GROUP_CONCAT( DISTINCT m.machine_id) as machine_id,
					count(DISTINCT machine_id) as frequency,
					( 
						select GROUP_CONCAT(m.`status`) from machine m where m.stores_id = s.stores_id 
						GROUP BY m.stores_id 
					) as `status`
				FROM
					 ( 
						select * from `user` 
					 ) u
				LEFT JOIN user_role_relation urr ON urr.user_id = u.id
				LEFT JOIN stores s ON s.stores_id = urr.stores_id
				LEFT JOIN machine m ON m.stores_id = urr.stores_id
				where u.`status` = 1
				and ( u.account = #{account} or u.phone = #{account} )
				<if test="keyword != null and keyword != ''">
					and CONCAT(s.stores_name,stores_city) LIKE '%${keyword}%'
				</if>
				GROUP BY u.account, s.stores_name
				having 1=1
			) as sum GROUP BY stores_city
  		) as sum
  	</select>
  	
  	<!-- 终端机管理 -->
  	<select id="getMachineInfo" resultType="com.alibaba.pojo.Machine" parameterType="com.alibaba.util.ParamInfo">
  		SELECT
			u.id,
			u.username,
			u.account,
			(
				case
					when s.stores_city = '' then '未录城市分类'
					else s.stores_city
				end
			) as stores_city,
			u.phone,
			s.stores_name,
			s.stores_id,
			GROUP_CONCAT( DISTINCT m.machine_name ORDER BY m.machine_name desc ) as machine_name,
			GROUP_CONCAT( DISTINCT m.machine_id order by m.machine_id desc) as machine_id,
			count(DISTINCT machine_id) as frequency,
			REVERSE(( 
				select GROUP_CONCAT(m.`status`) from machine m where m.stores_id = s.stores_id 
				<if test="status != null and status != ''">
					and m.`status` = #{status}
				</if>
				GROUP BY m.stores_id )) as `status`
		FROM
			 ( 
			 	select * from `user` 
			 ) u
		LEFT JOIN user_role_relation urr ON urr.user_id = u.id
		LEFT JOIN stores s ON s.stores_id = urr.stores_id
		LEFT JOIN machine m ON m.stores_id = urr.stores_id
		where u.`status` = 1
		and s.stores_name is NOT NULL and s.stores_name != ''
		and machine_name is NOT NULL and machine_name != ''
		<if test="status != null and status != ''">
			and m.`status` = #{status}
		</if>
		and u.id in ( ${content} )
		GROUP BY u.account,s.stores_name
		having 1=1
		<if test="keyword != null and keyword != ''">
			and CONCAT(s.stores_name,stores_city) LIKE '%${keyword}%'
		</if>
		and ( u.account = #{account} or u.phone = #{account} )
  		<!-- SELECT
  			u.phone,
			u.account,
			s.stores_city as stores_city,
			s.stores_name,
			s.stores_id,
			GROUP_CONCAT( DISTINCT m.machine_name order by m.machine_name desc ) as machine_name,
			GROUP_CONCAT( DISTINCT m.machine_id order by m.machine_id desc) as machine_id,
			count(DISTINCT machine_id) as frequency,
			REVERSE(( 
				select GROUP_CONCAT(m.`status`) from machine m where m.stores_id = s.stores_id 
				<if test="status != null and status != ''">
					and m.`status` = #{status}
				</if>
				GROUP BY m.stores_id )) as `status`
		FROM
			 ( 
				select * from `user`
			 ) u
		LEFT JOIN user_role_relation urr ON urr.user_id = u.id
		LEFT JOIN stores s ON s.stores_id = urr.stores_id
		LEFT JOIN machine m ON m.stores_id = urr.stores_id
		where u.`status` = 1
		and ( u.account = #{account} or u.phone = #{account} )
		and m.stores_id not in ( ${content} )
		<if test="status != null and status != ''">
			and m.`status` = #{status}
		</if>
		and stores_city in ( ${cityContent} )
		GROUP BY u.account, s.stores_name
		having 1=1
		<if test="keyword != null and keyword != ''">
			and CONCAT(s.stores_city, s.stores_name) LIKE '%${keyword}%'
		</if> -->
  	</select>
  	
  	<!-- 查询id供终端机列表分页 -->
	<select id="getUserIdGroup" resultType="java.lang.String" parameterType="com.alibaba.util.ParamInfo">
		select * from (
			SELECT
				u.id as id
			FROM
				 ( 
					select * from `user`
				 ) u
			LEFT JOIN user_role_relation urr ON urr.user_id = u.id
			LEFT JOIN stores s ON s.stores_id = urr.stores_id
			LEFT JOIN machine m ON m.stores_id = urr.stores_id
			where u.`status` = 1
			and s.stores_name is NOT NULL and s.stores_name != ''
			and machine_name is NOT NULL and machine_name != ''
			GROUP BY s.stores_name, u.account
			having 1=1 
		) as count GROUP BY id
		<if test="(pageNum != null and pageNum != '') and (pageSize != null and pageSize != '')">
			limit ${pageNum}, ${pageSize}
		</if>
	</select>
  	
  	
  	
  	
  	<!-- 分页查询城市 -->
  	<select id="getPageInfoCity" resultType="java.lang.String" parameterType="com.alibaba.util.ParamInfo">
  		select ( case when stores_city = '' then '未录城市分类' else stores_city end ) stores_city from (
			SELECT
				u.phone,
				u.account,
				s.stores_city as stores_city,
				s.stores_name,
				s.stores_id,
				GROUP_CONCAT( DISTINCT m.machine_name ) as machine_name,
				GROUP_CONCAT( DISTINCT m.machine_id) as machine_id,
				count(DISTINCT machine_id) as frequency,
				( 
					select GROUP_CONCAT(m.`status`) from machine m where m.stores_id = s.stores_id 
					GROUP BY m.stores_id ) as `status`
			FROM
				 ( 
					select * from `user`
				 ) u
			LEFT JOIN user_role_relation urr ON urr.user_id = u.id
			LEFT JOIN stores s ON s.stores_id = urr.stores_id
			LEFT JOIN machine m ON m.stores_id = urr.stores_id
			where u.`status` = 1
			and ( u.account = #{account} or u.phone = #{account} )
			and m.stores_id not in ( ${content} )
			GROUP BY u.account, s.stores_name
			having 1=1
		) as count GROUP BY stores_city
		<if test="(pageNum != null and pageNum != '') and (pageSize != null and pageSize != '')">
			limit ${pageNum}, ${pageSize}
		</if>
  	</select>
  	
  	<!-- 查询总数 -->
  	<select id="getCount" resultType="int" parameterType="com.alibaba.util.ParamInfo">
  		select count(1) from (
			select count(1) from (
				SELECT
					u.account,
					s.stores_name,
					s.stores_id,
					s.stores_city as stores_city,
					GROUP_CONCAT( DISTINCT m.machine_name ) as machine_name,
					GROUP_CONCAT( DISTINCT m.machine_id) as machine_id,
					count(DISTINCT machine_id) as frequency,
					( 
						select GROUP_CONCAT(m.`status`) from machine m where m.stores_id = s.stores_id 
						<if test="status != null and status != ''">
							and m.`status` = #{status}
						</if>
						GROUP BY m.stores_id ) as `status`
				FROM
					 ( 
						select * from `user`
					 ) u
				LEFT JOIN user_role_relation urr ON urr.user_id = u.id
				LEFT JOIN stores s ON s.stores_id = urr.stores_id
				LEFT JOIN machine m ON m.stores_id = urr.stores_id
				where u.`status` = 1
				and u.account = #{account}
				-- and m.stores_id not in ( ${content} )
				<if test="status != null and status != ''">
					and m.`status` = #{status}
				</if>
				GROUP BY u.account,s.stores_name
				having 1=1
				<if test="keyword != null and keyword != ''">
					and CONCAT(s.stores_city, s.stores_name) LIKE '%${keyword}%'
				</if>
			) as count GROUP BY stores_city
		) as count
  	</select>
  	
  	<!-- 查询要修改用户的头像 -->
  	<select id="getUserPic" resultType="com.alibaba.pojo.User" parameterType="com.alibaba.pojo.User">
  		select pic from user where account = #{account}
  	</select>
  	
  	<!-- 修改用户头像 -->
  	<update id="updateUserPic" parameterType="com.alibaba.pojo.User">
  		update user 
  		set pic = #{pic}
  		where account = #{account} 
  	</update>
  	
  	<!-- 查询用户手机号 -->	
	<select id="getUserPhone" resultType="java.lang.String" parameterType="com.alibaba.pojo.User">
		select phone from user where phone = #{phone} and status = 1
	</select>
  	
  	<!-- 修改用户密码的时候，根据账号查询用户的账号手机号 -->
  	<select id="getUserAccountPhoneInfo" resultType="com.alibaba.pojo.User">
  		select account, phone from user where account = #{account} and status = 1
  	</select>
  	
  	<!-- 根据密码判断用户是否是第一次登陆  -->
	<select id="getUserLastLogin" resultType="com.alibaba.pojo.User" parameterType="com.alibaba.pojo.User">
		select * from user where `password` = #{password} and status = 1
	</select>
	
	<!-- 用户第一次登陆，需设置用户密码 -->
	<update id="changeUserPwd" parameterType="com.alibaba.util.ParamInfo">
		update user set
		password = #{password}
		where phone = #{phone}
		and status = 1
	</update>
	
	<!-- 查询用户密码 -->
	<select id="getUserPwd" resultType="java.lang.String" parameterType="com.alibaba.util.ParamInfo">
		select `password` from user where account = #{account} and status = 1
	</select>
	
	<!-- 修改用户密码 -->
	<update id="updateUserPwd" parameterType="com.alibaba.pojo.User">
		update user set
		password = #{password}
		where account = #{account}
		and status = 1
	</update>
	
</mapper>