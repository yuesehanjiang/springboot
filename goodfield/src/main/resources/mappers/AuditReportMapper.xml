<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.alibaba.dao.AuditReportMapper">

	<!-- 门店信息 -->
	<resultMap id="base_resultMap" type="com.alibaba.pojo.Role">
		<id column="stores_id" property="stores_id" />
		<result column="stores_name" property="stores_name" />
		<!-- 权限信息 -->
		<collection property="relations" ofType="com.alibaba.pojo.Relation">
			<id column="relid" property="relid" />
			<result column="relationName" property="relationName" />
		</collection>
	</resultMap>
	
	<!-- 删除无效的图片地址 -->
	<delete id="delNomemberImageLibrary">
		delete from nomember_image_library where pic_path = #{value}
	</delete>
	
	<!-- 查询是否已读 -->
	<select id="getAuditReportUnread" parameterType="com.alibaba.util.ParamInfo" resultType="com.alibaba.util.ParamInfo">
		SELECT
			a.id,
			a.user_in_time,
			a.stores_id,
			s.stores_name,
			a.user_id,
			a.user_card,
			m.user_name,
			m.user_pic,
			( case when ISNULL(mp.running_water) then '-/-' else mp.running_water
			end ) as running_water,
			( case when ISNULL(mp.pic_path) then '-/-' else pic_path end ) as
			pic_path,
			a.appoint,
			( case when ISNULL(mp.user_id) then '-/-' else mp.user_id end ) as
			distinguish_id,
			a.valid_member,
			mp.flag
			FROM
			admission a
			LEFT JOIN membership m ON m.user_id = a.user_id
			LEFT JOIN
			management_pic mp ON mp.uuid = a.uuid and mp.user_id = a.user_id and
			date_add(mp.photo_time, interval 30 minute) > a.user_in_time
			LEFT JOIN
			stores s ON s.stores_id = a.stores_id
			where a.stores_id in ( ${content} )
			and mp.user_id is null
	</select>

	<!-- 查询稽核报告 -->
	<select id="getAuditReportInfo" parameterType="com.alibaba.util.ParamInfo"
		resultType="com.alibaba.util.ParamInfo">
		SELECT
		a.id,
		a.user_in_time,
		a.stores_id,
		s.stores_name,
		a.user_id,
		a.user_card,
		m.user_name,
		m.user_pic,
		( case when ISNULL(mp.running_water) then '-/-' else mp.running_water
		end ) as running_water,
		( case when ISNULL(mp.pic_path) then '-/-' else pic_path end ) as
		pic_path,
		a.appoint,
		( case when ISNULL(mp.user_id) then '-/-' else mp.user_id end ) as
		distinguish_id,
		a.valid_member,
		mp.flag
		FROM
		admission a
		LEFT JOIN membership m ON m.user_id = a.user_id
		LEFT JOIN
		management_pic mp ON mp.uuid = a.uuid and mp.user_id = a.user_id and
		date_add(mp.photo_time, interval 30 minute) <![CDATA[ > ]]> a.user_in_time
		LEFT JOIN
		stores s ON s.stores_id = a.stores_id
		<where>
			and a.stores_id in ( ${content} )
			and m.user_name != '' and m.user_name is not null
			<if test="isNull == '0'.toString()">
				and mp.user_id is null
			</if>
			<if test="isNull == '1'.toString()">
				and mp.user_id is not null
			</if>
			<if test="keyword != null and keyword != ''">
				and concat(a.user_id, a.user_card, m.user_name) like
				'%${keyword}%'
			</if>
			<if test="stores_id != null and stores_id != ''">
				and a.stores_id = #{stores_id}
			</if>
			<if test="datetime != null and datetime != ''">
				and date(a.user_in_time) = #{datetime}
			</if>
			<if
				test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(a.user_in_time) between #{startTime} and #{endTime}
			</if>
		</where>
		GROUP BY a.id
		order by a.id asc
		<if
			test="(pageNum != null and pageNum != '') and (pageSize != null and pageSize != '')">
			limit ${pageNum}, ${pageSize}
		</if>
	</select>

	<!-- 查询稽核报告门店列表信息 -->
	<select id="getUserRoleRelationInfo" resultMap="base_resultMap"
		parameterType="com.alibaba.util.ParamInfo">
		SELECT
		r.stores_id,
		r.stores_name,
		rel.relid,
		rel.relation_name AS relationName
		FROM
		(SELECT * FROM stores) r
		LEFT JOIN user_role_relation urr ON urr.stores_id =
		r.stores_id
		LEFT JOIN relation rel ON rel.relid = urr.relation_id
		LEFT
		JOIN `user` u ON u.id = urr.user_id
		WHERE
		u.id = #{user_id}
		and urr.relation_id = 5
	</select>

	<!-- 查询总数 -->
	<select id="getCount" resultType="int" parameterType="com.alibaba.util.ParamInfo">
		select count(1) from (
		SELECT
		a.id,
		a.user_in_time,
		a.stores_id,
		s.stores_name,
		a.user_id,
		a.user_card,
		m.user_name,
		m.user_pic,
		( case when ISNULL(mp.running_water) then '-/-' else mp.running_water
		end ) as running_water,
		( case when ISNULL(mp.pic_path) then '-/-' else pic_path end ) as
		pic_path,
		a.appoint,
		( case when ISNULL(mp.user_id) then '-/-' else mp.user_id end ) as
		distinguish_id,
		a.valid_member,
		mp.flag
		FROM
		admission a
		LEFT JOIN membership m ON m.user_id = a.user_id
		LEFT JOIN
		management_pic mp ON mp.uuid = a.uuid and mp.user_id = a.user_id and
		date_add(mp.photo_time, interval 30 minute) > a.user_in_time
		LEFT JOIN
		stores s ON s.stores_id = a.stores_id
		<where>
			and a.stores_id in ( ${content} )
			and m.user_name != '' and m.user_name is not null
			<if test="isNull == '0'.toString()">
				and mp.user_id is null
			</if>
			<if test="isNull == '1'.toString()">
				and mp.user_id is not null
			</if>
			<if test="keyword != null and keyword != ''">
				and concat(a.user_id, a.user_card, m.user_name) like
				'%${keyword}%'
			</if>
			<if test="stores_id != null and stores_id != ''">
				and a.stores_id = #{stores_id}
			</if>
			<if test="datetime != null and datetime != ''">
				and date(a.user_in_time) = #{datetime}
			</if>
			<if
				test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(a.user_in_time) between #{startTime} and #{endTime}
			</if>
		</where>
		GROUP BY a.id
		) as count
	</select>

	<!-- 查询总数 -->
	<select id="getCount2" resultType="int" parameterType="com.alibaba.util.ParamInfo">
		select count(1) from (
		select
		id,
		photo_time,
		pic_path
		from nomember_image_library
		<where>
			<if test="datetime != null and datetime != ''">
				and date(photo_time) = #{datetime}
			</if>
			<if
				test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(photo_time) between #{startTime} and #{endTime}
			</if>
		</where>
		) as count
	</select>

	<!-- 查询非会员图像库 -->
	<select id="getNomemberImageLibraryInfo" resultType="com.alibaba.pojo.NomemberImageLibrary"
		parameterType="com.alibaba.util.ParamInfo">
		select
		id,
		photo_time,
		pic_path
		from nomember_image_library
		<where>
			<if test="datetime != null and datetime != ''">
				and date(photo_time) = #{datetime}
			</if>
			<if
				test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(photo_time) between #{startTime} and #{endTime}
			</if>
		</where>
		<if
			test="(pageNum != null and pageNum != '') and ( pageSize != null and pageSize != '' ) ">
			limit ${pageNum}, ${pageSize}
		</if>
	</select>

	<!-- 查询总数 -->
	<select id="getCount3" resultType="int" parameterType="com.alibaba.util.ParamInfo">
		select count(1) from (
		SELECT
		id,
		photo_time,
		pic_path
		FROM
		nomember_image_library
		<where>
			<if
				test="(datetime1 == null or datetime1 == '') and (datetime2 == null or datetime2 == '') and (datetime3 == null or datetime3 == '')">
				AND photo_time > DATE_ADD(NOW(), INTERVAL - 30 MINUTE)
			</if>
			<if test="datetime1 != null and datetime1 != ''">
					<![CDATA[ AND photo_time > DATE_ADD(NOW(), INTERVAL - 5 MINUTE) ]]>
			</if>
			<if test="datetime2 != null and datetime2 != ''">
					<![CDATA[ 
						AND photo_time < DATE_ADD(NOW(), INTERVAL - 5 MINUTE)
						AND photo_time > DATE_ADD(NOW(), INTERVAL - 10 MINUTE)
					 ]]>
			</if>
			<if test="datetime3 != null and datetime3 != ''">
					<![CDATA[ 
						AND photo_time < DATE_ADD(NOW(), INTERVAL - 10 MINUTE)
						AND photo_time > DATE_ADD(NOW(), INTERVAL - 30 MINUTE)
					]]>
			</if>
		</where>
		) as count
	</select>

	<!-- 查询30分钟以内的调整图像库 -->
	<select id="getNomemberImageInterval" parameterType="com.alibaba.util.ParamInfo"
		resultType="com.alibaba.pojo.NomemberImageLibrary">
		SELECT
		id,
		photo_time,
		pic_path
		FROM
		nomember_image_library
		<where>
			AND photo_time > DATE_ADD(NOW(), INTERVAL - 30 MINUTE)
			<if test="datetime1 != null and datetime1 != ''">
				<![CDATA[ AND photo_time > DATE_ADD(NOW(), INTERVAL - 5 MINUTE) ]]>
			</if>
			<if test="datetime2 != null and datetime2 != ''">
				<![CDATA[ 
					AND photo_time < DATE_ADD(NOW(), INTERVAL - 5 MINUTE)
					AND photo_time > DATE_ADD(NOW(), INTERVAL - 10 MINUTE)
				 ]]>
			</if>
			<if test="datetime3 != null and datetime3 != ''">
				<![CDATA[ 
					AND photo_time < DATE_ADD(NOW(), INTERVAL - 10 MINUTE)
					AND photo_time > DATE_ADD(NOW(), INTERVAL - 30 MINUTE)
				]]>
			</if>
		</where>
		<if
			test="(pageNum != null and pageNum != '') and ( pageSize != null and pageSize != '' ) ">
			limit ${pageNum}, ${pageSize}
		</if>
	</select>

	<!-- 点击调整图像的时候传参数过去 -->
	<select id="getadjustTheImageById" resultType="com.alibaba.pojo.ManagementPic"
		parameterType="com.alibaba.pojo.ManagementPic">
		select a.user_id,a.uuid from admission a where id = #{id}
	</select>

	<!-- 查询时间 -->
	<select id="getTime" resultType="java.lang.String"
		parameterType="com.alibaba.pojo.ManagementPic">
		select date_add(mp.photo_time, interval 30 minute) from management_pic mp
		where uuid = #{uuid}
	</select>

	<!-- 修改时间 -->
	<update id="updateUserInTime" parameterType="com.alibaba.pojo.Admission">
		update admission set
		user_in_time = #{user_in_time}
		where uuid = #{uuid}
	</update>

	<!-- 删除吧 -->
	<delete id="deleteByUUid" parameterType="com.alibaba.pojo.ManagementPic">
		delete from management_pic where uuid = #{uuid}
	</delete>

	<!-- 调整完毕 -->
	<insert id="adjustTheImage" parameterType="com.alibaba.pojo.ManagementPic">
		insert into management_pic (
		pic_path,
		user_id,
		photo_time,
		running_water,
		user_type,
		flag,
		uuid
		) values (
		#{pic_path},
		#{user_id},
		now(),
		#{running_water},
		1,
		0,
		#{uuid}
		)
	</insert>

	<!-- 再次修改调整图像 -->
	<update id="updateJustTheImage" parameterType="com.alibaba.pojo.ManagementPic">
		update management_pic
		set pic_path = #{pic_path}
		where uuid = #{uuid}
	</update>

</mapper>