<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.alibaba.dao.AuditReportMapper">
  
  	<!-- 门店信息 -->
	<resultMap id="base_resultMap" type="com.alibaba.pojo.Role">
		<id column="stores_id" property="stores_id" />
		<result column="stores_name" property="stores_name" />
		<!-- 权限信息 -->
		<collection property="relations" ofType="com.alibaba.pojo.Relation">
			<id column="relid" property="relid" />
			<result column="relationName" property="relationName" />
		</collection>
	</resultMap>
  
  	<!-- 查询稽核报告 -->
  	<select id="getAuditReportInfo" parameterType="com.alibaba.util.ParamInfo" resultType="com.alibaba.util.ParamInfo">
  		SELECT
			a.id,
			a.user_in_time,
			a.stores_id,
			s.stores_name,
			a.user_id,
			a.user_card,
			m.user_name,
			m.user_pic,
			mp.running_water,
		    ( case when a.valid_member = '0' then '' else pic_path end ) as pic_path,
			a.appoint,
			( case when a.valid_member = '0' then '-/-' else a.user_id end ) as distinguish_id,
			a.valid_member
		FROM
			admission a
		LEFT JOIN membership m ON m.user_id = a.user_id
		LEFT JOIN management_pic mp ON mp.user_id = a.user_id
		LEFT JOIN stores s ON s.stores_id = a.stores_id
		<where>
			and a.stores_id in ( ${content} )
			<if test="keyword != null and keyword != ''">
				and concat(a.user_id, a.user_card, m.user_name) like '%${keyword}%'
			</if>
			<if test="stores_id != null and stores_id != ''">
				and a.stores_id = #{stores_id}
			</if>
			<if test="datetime != null and datetime != ''">
				and date(a.user_in_time) = #{datetime}
			</if>
			<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(a.user_in_time) between #{startTime} and #{endTime}
			</if>
		</where>
		order by a.id asc
		<if test="(pageNum != null and pageNum != '') and (pageSize != null and pageSize != '')">
			limit ${pageNum}, ${pageSize}
		</if>
  	</select>
  	
  	<!-- 查询稽核报告门店列表信息 -->
	<select id="getUserRoleRelationInfo" resultMap="base_resultMap" parameterType="com.alibaba.util.ParamInfo">
		SELECT
			r.stores_id,
			r.stores_name,
			rel.relid,
			rel.relation_name AS relationName
		FROM
			(SELECT * FROM stores) r
		LEFT JOIN user_role_relation urr ON urr.stores_id = r.stores_id
		LEFT JOIN relation rel ON rel.relid = urr.relation_id
		LEFT JOIN `user` u ON u.id = urr.user_id
		WHERE
			u.id = #{user_id}
		and urr.relation_id = 5
	</select>
  	
  	<!-- 查询总数 -->
  	<select id="getCount" resultType="int" parameterType="com.alibaba.util.ParamInfo">
  		select count(1) from (
	  		SELECT
				a.id,
				a.user_in_time,
				a.stores_id,
				a.user_id,
				a.user_card,
				m.user_name,
				m.user_pic,
				mp.running_water,
			    ( case when a.valid_member = '0' then '调整图像' else pic_path end ) as pic_path,
				a.appoint,
				( case when a.valid_member = '0' then '-/-' else a.user_id end ) as distinguish_id,
				a.valid_member
			FROM
				admission a
			LEFT JOIN membership m ON m.user_id = a.user_id
			LEFT JOIN management_pic mp ON mp.user_id = a.user_id
			<where>
				and a.stores_id in ( ${content} )
				<if test="keyword != null and keyword != ''">
					and concat(a.user_id, a.user_card, m.user_name) like '%${keyword}%'
				</if>
				<if test="stores_id != null and stores_id != ''">
					and a.stores_id = #{stores_id}
				</if>
				<if test="datetime != null and datetime != ''">
					and date(a.user_in_time) = #{datetime}
				</if>
				<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
					and date(a.user_in_time) between #{startTime} and #{endTime}
				</if>
			</where>
		) as count
  	</select>
  	
  	<!-- 查询总数 -->
  	<select id="getCount2" resultType="int" parameterType="com.alibaba.util.ParamInfo">
  		select count(1) from (
  			select 
	  			id,
				image_name,
				photo_time,
				pic_path
			from nomember_image_library
			<where>
				<if test="datetime != null and datetime != ''">
					and date(photo_time) = #{datetime}
				</if>
				<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
					and photo_time between #{startTime} and #{endTime}
				</if>
			</where>
		) as count
  	</select>
  	
  	<!-- 查询非会员图像库 -->
  	<select id="getNomemberImageLibraryInfo" resultType="com.alibaba.pojo.NomemberImageLibrary" parameterType="com.alibaba.util.ParamInfo">
  		select 
  			id,
			image_name,
			photo_time,
			pic_path
		from nomember_image_library
		<where>
			<if test="datetime != null and datetime != ''">
				and date(photo_time) = #{datetime}
			</if>
			<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(photo_time) between #{startTime} and #{endTime}
			</if>
		</where>
		<if test="(pageNum != null and pageNum != '') and ( pageSize != null and pageSize != '' ) ">
			limit ${pageNum}, ${pageSize}
		</if>
  	</select>
  	
  	<!-- 查询总数 -->
  	<select id="getCount3" resultType="int" parameterType="com.alibaba.util.ParamInfo">
  		select count(1) from (
	  		SELECT
				id,
				image_name,
				photo_time,
				pic_path
			FROM
				nomember_image_library
			<where>
				<if test="(datetime1 == null or datetime1 == '') and (datetime2 == null or datetime2 == '') and (datetime3 == null or datetime3 == '')">
					AND photo_time > DATE_ADD(NOW(), INTERVAL - 30 MINUTE)
				</if>
				<if test="datetime1 != null and datetime1 != ''">
					<![CDATA[ AND photo_time > DATE_ADD(NOW(), INTERVAL - 5 MINUTE) ]]>
				</if>  
				<if test="datetime2 != null and datetime2 != ''">
					<![CDATA[ 
						AND photo_time < DATE_ADD(NOW(), INTERVAL - 5 MINUTE)
						AND photo_time > DATE_ADD(NOW(), INTERVAL - 10 MINUTE)
					 ]]>
				</if>
				<if test="datetime3 != null and datetime3 != ''">
					<![CDATA[ 
						AND photo_time < DATE_ADD(NOW(), INTERVAL - 10 MINUTE)
						AND photo_time > DATE_ADD(NO1W(), INTERVAL - 30 MINUTE)
					]]>
				</if>
			</where>
		) as count
  	</select>
  	
  	<!-- 查询30分钟以内的调整图像库 -->
  	<select id="getNomemberImageInterval" parameterType="com.alibaba.util.ParamInfo" resultType="com.alibaba.pojo.NomemberImageLibrary">
  		SELECT
			id,
			image_name,
			photo_time,
			pic_path
		FROM
			nomember_image_library
		<where>
			<if test="(datetime1 == null or datetime1 == '') and (datetime2 == null or datetime2 == '') and (datetime3 == null or datetime3 == '')">
				AND photo_time > DATE_ADD(NOW(), INTERVAL - 30 MINUTE)
			</if>
			<if test="datetime1 != null and datetime1 != ''">
				<![CDATA[ AND photo_time > DATE_ADD(NOW(), INTERVAL - 5 MINUTE) ]]>
			</if> 
			<if test="datetime2 != null and datetime2 != ''">
				<![CDATA[ 
					AND photo_time < DATE_ADD(NOW(), INTERVAL - 5 MINUTE)
					AND photo_time > DATE_ADD(NOW(), INTERVAL - 10 MINUTE)
				 ]]>
			</if>
			<if test="datetime3 != null and datetime3 != ''">
				<![CDATA[ 
					AND photo_time < DATE_ADD(NOW(), INTERVAL - 10 MINUTE)
					AND photo_time > DATE_ADD(NO1W(), INTERVAL - 30 MINUTE)
				]]>
			</if>
		</where>
		<if test="(pageNum != null and pageNum != '') and ( pageSize != null and pageSize != '' ) ">
			limit ${pageNum}, ${pageSize}
		</if>
  	</select>
  	
  	<!-- 调整完毕，修改状态 -->
  	<update id="updateAdmissionValidMember" parameterType="com.alibaba.util.ParamInfo">
  		update admission set
		valid_member = 1
		where user_id = #{user_id}
  	</update>
  	
  	<!-- 调整完毕，修改状态 -->
  	<update id="updatemanagementPicPath" parameterType="com.alibaba.util.ParamInfo">
  		update management_pic set
		pic_path = #{pic_path}
		where user_id = #{user_id}
  	</update>
    
</mapper>