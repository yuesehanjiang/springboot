<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.alibaba.dao.EntranceReportMapper">
  	
  	<!-- 门店信息 -->
	<resultMap id="base_resultMap" type="com.alibaba.pojo.Role">
		<id column="stores_id" property="stores_id" />
		<result column="stores_name" property="stores_name" />
		<!-- 权限信息 -->
		<collection property="relations" ofType="com.alibaba.pojo.Relation">
			<id column="relid" property="relid" />
			<result column="relationName" property="relationName" />
		</collection>
	</resultMap>
  	
  	<!-- 查询入场报告门店列表信息 -->
	<select id="getUserRoleRelationInfo" resultMap="base_resultMap" parameterType="com.alibaba.util.ParamInfo">
		SELECT
			r.stores_id,
			r.stores_name,
			rel.relid,
			rel.relation_name AS relationName
		FROM
			(SELECT * FROM stores) r
		LEFT JOIN user_role_relation urr ON urr.stores_id = r.stores_id
		LEFT JOIN relation rel ON rel.relid = urr.relation_id
		LEFT JOIN `user` u ON u.id = urr.user_id
		WHERE
			u.id = #{user_id}
		and urr.relation_id = 4
	</select>
	
 	<!-- 查询入场报告-会员+门店 -->
  	<select id="getEntranceReportInfo" resultType="com.alibaba.util.ParamInfo" parameterType="com.alibaba.util.ParamInfo">
  		SELECT
			a.id,
			a.stores_id,
			s.stores_name,
			m.user_name,
			a.user_id,
			a.user_card,
			m.user_pic,
			count(a.user_id) as frequency,
			mp.user_type,
			a.user_in_time
		FROM
			admission a
		LEFT JOIN membership m ON m.user_id = a.user_id
		LEFT JOIN management_pic mp ON mp.user_id = a.user_id
		LEFT JOIN stores s ON s.stores_id = a.stores_id
		GROUP BY a.user_id <if test="(datetime != null and datetime != '') or ( ( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' ) ) ">,a.user_in_time</if>
		<if test="stores_id != null and stores_id != ''">,a.stores_id</if>
		having 1=1
		and a.stores_id in ( ${content} )
		and mp.user_type = #{user_type}
		<if test="keyword != null and keyword != ''">
			and concat(m.user_name, a.user_id, a.user_card) like '%${keyword}%'
		</if>
		<if test="stores_id != null and stores_id != ''">
			and a.stores_id = #{stores_id}
		</if>
		<if test="datetime != null and datetime != ''">
			and date(a.user_in_time) = #{datetime}
		</if>
		<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
			and date(a.user_in_time) between #{startTime} and #{endTime}
		</if>
		<if test="positive != null and positive != ''">
			order by frequency desc
		</if>
		<if test="reverse != null and reverse != ''">
			order by frequency asc
		</if>
		<if test="(pageNum != null and pageNum != '') and ( pageSize != null and pageSize != '' ) ">
			limit ${pageNum}, ${pageSize}
		</if>
  	</select>
  	
  	<!-- 筛选非会员数据 -->
  	<select id="getEntranceReportNonMemberInfo" resultType="com.alibaba.util.ParamInfo" parameterType="com.alibaba.util.ParamInfo">
  		select 
			nm.stores_id,
			nm.user_name,
			( case  when 1 = 1 then '-/-' end ) as user_id,
			( case  when 1 = 1 then '-/-' end ) as user_card,
			( case  when 1 = 1 then '-/-' end ) as user_pic,
			( case  when 1 = 1 then '1' end ) as frequency,
			nm.id,
			s.stores_name
		 from non_member nm
		 LEFT JOIN stores s ON s.stores_id = nm.stores_id
		<where>
		 	<if test="stores_id != null and stores_id != ''">
		 		and nm.stores_id = #{stores_id}
		 	</if>
		 	<if test="keyword != null and keyword != ''">
				and nm.user_name like '%${keyword}%'
			</if>
		 	<if test="datetime != null and datetime != ''">
		 		and date(nm.user_in_time) = #{datetime}
		 	</if>
		 	<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(nm.user_in_time) between #{startTime} and #{endTime}
			</if>
		 </where>
		<if test="(pageNum != null and pageNum != '') and ( pageSize != null and pageSize != '' ) ">
			limit ${pageNum}, ${pageSize}
		</if>
  	</select>
  	
  	<!-- 筛选非会员详情数据 -->
  	<select id="getEntranceReportNonMemberDetails" resultType="com.alibaba.util.ParamInfo" parameterType="com.alibaba.util.ParamInfo">
  		select 
			nm.stores_id,
			nm.user_name,
			s.stores_name,
			( case  when 1 = 1 then '-/-' end ) as user_id,
			( case  when 1 = 1 then '-/-' end ) as user_card,
			nm.user_in_time,
			( case  when 1 = 1 then '-/-' end ) as pic_path,
			nm.id
		 from non_member nm
		 LEFT JOIN stores s ON s.stores_id = nm.stores_id
		 where id = #{id}
  	</select>
  	
  	<!-- 查询总数 -->
  	<select id="getCount" resultType="int" parameterType="com.alibaba.util.ParamInfo">
  		select count(1) from (
	  		SELECT
				a.id,
				a.stores_id,
				m.user_name,
				a.user_id,
				a.user_card,
				m.user_pic,
				count(a.user_id) as frequency,
				mp.user_type,
				a.user_in_time
			FROM
				admission a
			LEFT JOIN membership m ON m.user_id = a.user_id
			LEFT JOIN management_pic mp ON mp.user_id = a.user_id
			GROUP BY a.user_id <if test="(datetime != null and datetime != '') or ( ( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' ) ) ">,a.user_in_time</if>
			<if test="stores_id != null and stores_id != ''">,a.stores_id</if>
			having 1=1
			and a.stores_id in ( ${content} )
			and mp.user_type = #{user_type}
			<if test="keyword != null and keyword != ''">
				and concat(m.user_name, a.user_id, a.user_card) like '%${keyword}%'
			</if>
			<if test="stores_id != null and stores_id != ''">
				and a.stores_id = #{stores_id}
			</if>
			<if test="datetime != null and datetime != ''">
				and date(a.user_in_time) = #{datetime}
			</if>
			<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(a.user_in_time) between #{startTime} and #{endTime}
			</if>
		) as count
  	</select>
  	
  	<!-- 查询总数 -->
  	<select id="getCount2" resultType="int" parameterType="com.alibaba.util.ParamInfo">
  		select count(1) from (
	  		SELECT
				a.id,
				a.stores_id,
				m.user_name,
				a.user_id,
				a.user_card,
				m.user_pic,
				mp.user_type,
				a.user_in_time
			FROM
				admission a
			LEFT JOIN membership m ON m.user_id = a.user_id
			LEFT JOIN management_pic mp ON mp.user_id = a.user_id
			where a.stores_id in ( ${content} )
			and a.user_id = #{u_id}
			<if test="stores_id != null and stores_id != ''">
				and a.stores_id = #{stores_id}
			</if>
			<if test="datetime != null and datetime != ''">
				and date(a.user_in_time) = #{datetime}
			</if>
			<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
				and date(a.user_in_time) between #{startTime} and #{endTime}
			</if>
		) as count
  	</select>
  	
  	<!-- 查询总数 -->
  	<select id="getCount3" resultType="int" parameterType="com.alibaba.util.ParamInfo">
  		select count(1) from (
	  		select 
				stores_id,
				user_name,
				( case  when 1 = 1 then '-/-' end ) as user_id,
				( case  when 1 = 1 then '-/-' end ) as user_card,
				( case  when 1 = 1 then '-/-' end ) as user_pic,
				( case  when 1 = 1 then '1' end ) as frequency,
				id
			 from non_member
			<where>
			 	<if test="stores_id != null and stores_id != ''">
			 		and stores_id = #{stores_id}
			 	</if>
			 	<if test="keyword != null and keyword != ''">
					and user_name like '%${keyword}%'
				</if>
			 	<if test="datetime != null and datetime != ''">
			 		and date(user_in_time) = #{datetime}
			 	</if>
			 	<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
					and date(user_in_time) between #{startTime} and #{endTime}
				</if>
			 </where>
		) as count
  	</select>
	
	<!-- 查询入场次数详情-会员+门店 -->
	<select id="getgetEntranceReportDetails" resultType="com.alibaba.util.ParamInfo" parameterType="com.alibaba.util.ParamInfo">
		SELECT
			a.id,
			a.stores_id,
			m.user_name,
			a.user_id,
			a.user_card,
			m.user_pic,
			mp.user_type,
			a.user_in_time,
			s.stores_name
		FROM
			admission a
		LEFT JOIN membership m ON m.user_id = a.user_id
		LEFT JOIN management_pic mp ON mp.user_id = a.user_id
		LEFT JOIN stores s ON s.stores_id = a.stores_id
		where a.stores_id in ( ${content} )
		and a.user_id = #{u_id}
		<if test="stores_id != null and stores_id != ''">
			and a.stores_id = #{stores_id}
		</if>
		<if test="datetime != null and datetime != ''">
			and date(a.user_in_time) = #{datetime}
		</if>
		<if test="( startTime != null and startTime != '' ) and ( endTime != null and endTime != '' )">
			and date(a.user_in_time) between #{startTime} and #{endTime}
		</if>
		<if test="(pageNum != null and pageNum != '') and ( pageSize != null and pageSize != '' ) ">
			limit ${pageNum}, ${pageSize}
		</if>
	</select>
	
</mapper>